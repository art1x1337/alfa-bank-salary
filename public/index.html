<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Solushn Bank Edition</title>
  <style>

     * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f4f6f9;
}

.app-header {
  background: white;
  padding: 18px;
  text-align: center;
  font-size: 16px;
  font-weight: 600;
  color: #1e293b;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  position: sticky;
  top: 0;
  z-index: 10;
}

.income {
  margin-bottom: 10px;
}

.amount {
  font-size: 20px;
  font-weight: 600;
  color: #1e3a8a;
}

.goal-block {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.goal-block input {
  flex: 1;
  padding: 8px;
  border: 1px solid #ffffff;
  border-radius: 8px;
}

.goal-block button {
  padding: 8px 14px;
  background: #2563eb;
  color: rgb(255, 251, 251);
  border: none;
  border-radius: 8px;
  font-weight: 600;
}

.progress-wrapper {
  margin-top: 15px;
  background: #ffffff;
  border-radius: 10px;
  height: 10px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #2563eb, #3b82f6);
  transition: width 0.3s ease;
}

.percent {
  margin-top: 5px;
  font-size: 14px;
  color: #64748b;
}

.products {
  padding: 15px;
}

.products h2 {
  margin: 20px 0 10px;
  font-size: 16px;
  color: #1e293b;
}

.card {
  background: rgb(230, 223, 223);
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.15s ease;
}

.card:active {
  transform: scale(0.98);
}

.product {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.product-name {
  font-weight: 500;
  color: #1e293b;
}

.price {
  font-size: 13px;
  color: #64748b;
}

.controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.controls button {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: none;
  background: #2563eb;
  color: white;
  font-size: 18px;
  font-weight: bold;
}

.controls button:active {
  transform: scale(0.95);
}

.controls button.minus {
  background: #94a3b8;
}

.count {
  min-width: 20px;
  text-align: center;
  font-weight: 600;
}

.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #2563eb;
  color: white;
  padding: 10px 18px;
  border-radius: 20px;
  opacity: 0;
  transition: 0.3s;
  font-size: 14px;
}

.category-title {
  margin: 20px 0 10px;
  font-size: 14px;
  font-weight: 600;
  color: #2563eb;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.container {
  max-width: 480px;
  margin: 0 auto;
  padding: 15px;
}

.progress-container {
  margin-top: 15px;
  background: #e2e8f0;
  border-radius: 10px;
  height: 14px;
  overflow: hidden;
}

.bottom-actions {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.bottom-actions button {
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  background: #2563eb;
  color: white;
}

.bottom-actions .logout {
  background: #ef4444;
}

    </style>
</head>
<body>

<div class="app-header">
  <h1>–ê–ª—å—Ñ–∞ –°–æ–ª—é—à–Ω ‚Äî KPI Tracker</h1>
</div>

<div class="container">

<div id="auth">
  <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="regEmail" placeholder="Email">
  <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

  <h3>–õ–æ–≥–∏–Ω</h3>
  <input id="logEmail" placeholder="Email">
  <input id="logPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="login()">–í–æ–π—Ç–∏</button>
</div>

<div id="app" style="display:none;">
  <div id="products"></div>

  <div class="total-box">
     üí∞ –°–µ–≥–æ–¥–Ω—è: <span id="todayIncome">0</span> ‚ÇΩ
  <br><br>
  üìÜ –ú–µ—Å—è—Ü: <span id="monthIncome">0</span> ‚ÇΩ
  <br><br>
  üéØ –¶–µ–ª—å:
  <input id="goalInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å">
  <button onclick="setGoal()">OK</button>
  <br><br>
  <div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
</div>
<div class="percent">
  <span id="goalPercent">0</span>%
</div>
</div>
<div class="bottom-actions">
  <button onclick="generateReport()">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á—ë—Ç</button>
  <button class="logout" onclick="logout()">–í—ã–π—Ç–∏</button>
</div>

<script>

async function generateReport() {
  const token = localStorage.getItem("token");

  const res = await fetch("/stats?period=today", {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();

  let report = "–í—ã–ø–æ–ª–Ω–µ–Ω–æ:\n";

  data.products
    .filter(p => p.category === "done" && p.total_quantity > 0)
    .forEach(p => {
      report += `${p.name}: ${p.total_quantity}\n`;
    });

  report += "\n–ü—Ä–æ–¥–∞–∂–∏:\n";

  data.products
    .filter(p => p.category === "sales" && p.total_quantity > 0)
    .forEach(p => {
      report += `${p.name}: ${p.total_quantity}\n`;
    });

  report += "\n–ö–æ–Ω–∫—É—Ä—Å:\n";

  data.products
    .filter(p => p.category === "contest" && p.total_quantity > 0)
    .forEach(p => {
      report += `${p.name}: ${p.total_quantity}\n`;
    });

  document.getElementById("reportText").value = report;
  document.getElementById("reportBlock").style.display = "block";
}

function showApp() {
  document.getElementById("auth").style.display = "none";
  document.getElementById("app").style.display = "block";
}

function logout() {
  localStorage.removeItem("token");
  location.reload();
}

if (localStorage.getItem("token")) {
  showApp();
  loadProducts();
  loadStats();
}

async function register() {
  const email = regEmail.value;
  const password = regPass.value;

  await fetch("/register", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({email, password})
  });

  alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω");
}

async function login() {
  const email = logEmail.value;
  const password = logPass.value;

  const res = await fetch("/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({email, password})
  });

  const data = await res.json();

  if (data.token) {
    localStorage.setItem("token", data.token);
    showApp();
    loadProducts();
    loadStats();
  } else {
    alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
  }
}

async function loadProducts() {
  const token = localStorage.getItem("token");

  const res = await fetch("/products", {
    headers: { "Authorization": "Bearer " + token }
  });

  const products = await res.json();

  const container = document.getElementById("products");
  container.innerHTML = "";

  ["done", "sales", "contest"].forEach(cat => {

    const section = document.createElement("h2");
    section.textContent =
      cat === "done" ? "–í—ã–ø–æ–ª–Ω–µ–Ω–æ" :
      cat === "sales" ? "–ü—Ä–æ–¥–∞–∂–∏" :
      "–ö–æ–Ω–∫—É—Ä—Å";

    container.appendChild(section);

    products
      .filter(p => p.category === cat)
      .forEach(product => {

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="product">
            <div>
              <div class="product-name">${product.name}</div>
              <div class="price">${product.price} ‚ÇΩ</div>
            </div>

            <div class="controls">
              <button class="minus" onclick="removeSale(${product.id})">-</button>
              <span id="count-${product.id}" class="count">0</span>
              <button class="plus" onclick="addSale(${product.id})">+</button>
            </div>
          </div>
        `;

        container.appendChild(card);
      });

  });

  loadStats();
}

async function setGoal() {
  const token = localStorage.getItem("token");
  const goal = document.getElementById("goalInput").value;

  await fetch("/set-goal", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ goal: goal })
  });

  showToast("–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
  loadStats();
}

async function addSale(productId) {
  const token = localStorage.getItem("token");

  const res = await fetch("/sales", {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization":"Bearer " + token
    },
    body: JSON.stringify({product_id: productId})
  });

  console.log(res.status);

  loadStats();
}

async function removeSale(productId) {
  const token = localStorage.getItem("token");

  await fetch("/sales/" + productId, {
    method: "DELETE",
    headers: {
      "Authorization":"Bearer " + token
    }
  });

  loadStats();
}

async function loadStats() {
   const token = localStorage.getItem("token");

  const todayRes = await fetch("/stats?period=today", {
    headers: { "Authorization":"Bearer " + token }
  });
  const todayData = await todayRes.json();

  const monthRes = await fetch("/stats?period=month", {
    headers: { "Authorization":"Bearer " + token }
  });
  const monthData = await monthRes.json();

  todayData.products.forEach(product => {
  const count = product.total_quantity || 0;

  const el = document.getElementById("count-" + product.id);
  if (el) el.textContent = count;

  const minusBtn = document.querySelector(
    'button[onclick="removeSale(' + product.id + ')"]'
  );

  if (minusBtn) {
    minusBtn.disabled = count === 0;
    minusBtn.style.opacity = count === 0 ? "0.4" : "1";
  }
});

  document.getElementById("todayIncome").textContent = todayData.total_income;
  document.getElementById("monthIncome").textContent = monthData.total_income;

  document.getElementById("goalInput").value = monthData.goal || "";

  const goalInput = document.getElementById("goalInput").value;
  const goal = Number(goalInput) || 0;
  const monthIncome = Number(monthData.total_income) || 0;

  const percent = goal > 0 ? (monthIncome / goal) * 100 : 0;

  document.getElementById("goalPercent").textContent = Math.floor(percent);
  document.getElementById("progressBar").style.width = percent + "%";
}

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.opacity = "1";

  setTimeout(() => {
    toast.style.opacity = "0";
  }, 2000);
}

</script>

<div id="toast" class="toast">–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞</div>
<div id="reportBlock" style="display:none; margin-top:20px;">
  <h3 style="margin-bottom:10px;">–û—Ç—á—ë—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
  <textarea 
    id="reportText"
    readonly
    style="
      width:100%;
      height:150px;
      padding:10px;
      border-radius:10px;
      border:1px solid #e2e8f0;
      font-size:14px;
      resize:none;
    ">
  </textarea>
</div>

</body>
</html>

